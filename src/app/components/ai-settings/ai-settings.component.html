<div class="settings-container">
    <div *ngIf="progress().isProcessing || progress().isPaused" class="progress-bar-container">
        <div class="progress-info">
            <span>{{ progress().currentBatch }}</span>
            <span>{{ progress().processed }} / {{ progress().total }}</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="(progress().processed / progress().total) * 100"></div>
        </div>
        <div class="progress-controls">
            <button class="control-btn pause-btn" (click)="togglePause()">
                {{ progress().isPaused ? 'Resume' : 'Pause' }}
            </button>
            <button class="control-btn cancel-btn" (click)="cancelCategorization()">
                Cancel
            </button>
        </div>
    </div>
    <div class="header">
        <h2>AI Categorization</h2>
    </div>

    <section class="config-section">
        <div class="section-header">
            <h3>LLM Configuration</h3>
            <button class="discovery-trigger-btn" (click)="openDiscovery()">Discover local models</button>
        </div>
        <form [formGroup]="configForm" (ngSubmit)="saveConfig()">
            <div class="form-group">
                <label for="baseUrl">Base URL (OpenAI compatible)</label>
                <input id="baseUrl" type="text" formControlName="baseUrl" placeholder="http://localhost:11434/v1">
            </div>
            <div class="form-group">
                <label for="apiKey">API Key (if required)</label>
                <input id="apiKey" type="password" formControlName="apiKey" placeholder="Leave empty for local LLM">
            </div>
            <div class="form-group">
                <label for="model">Model Name</label>
                <input id="model" type="text" formControlName="model" placeholder="llama3:8b">
            </div>
            <button type="submit" [disabled]="!configForm.dirty">Save Configuration</button>
        </form>
    </section>

    <section class="tags-section">
        <div class="section-header">
            <h3>Available Tags Pool</h3>
            <button class="batch-btn" (click)="categorizeAllBookmarks()" [disabled]="progress().isProcessing">
                {{ progress().isProcessing ? 'Processing...' : 'Categorize All Bookmarks' }}
            </button>
        </div>
        <p class="hint">These tags will be suggested to the AI for categorization.</p>

        <div class="tag-input-group">
            <input #tagInput type="text" placeholder="Add new tag..." (keyup.enter)="addTag(tagInput)">
            <button (click)="addTag(tagInput)">Add</button>
        </div>

        <div class="tags-list">
            @for (tag of availableTags(); track tag) {
            <div class="tag-item">
                <span>{{ tag }}</span>
                <button class="remove-tag" (click)="removeTag(tag)">×</button>
            </div>
            }
        </div>
    </section>

    <!-- Model Discovery Modal -->
    <div *ngIf="showDiscoveryModal()" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Discover Local Models</h3>
                <button class="close-btn" (click)="closeDiscovery()">×</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label>Provider</label>
                    <select [ngModel]="selectedProvider()" (ngModelChange)="onProviderChange($event)"
                        [compareWith]="compareProviders">
                        <option *ngFor="let provider of providers" [ngValue]="provider">{{ provider.name }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Base URL</label>
                    <input type="text" [value]="selectedProvider().discoveryUrl" readonly>
                </div>

                <button class="action-btn" (click)="discoverModels()" [disabled]="isDiscovering()">
                    {{ isDiscovering() ? 'Discovering...' : 'Discover models' }}
                </button>

                <div *ngIf="discoveryError()" class="error-msg">
                    {{ discoveryError() }}
                </div>

                <div *ngIf="discoveredModels().length > 0" class="form-group results-group">
                    <label>Available Models</label>
                    <select [ngModel]="selectedDiscoveredModel()" (ngModelChange)="selectedDiscoveredModel.set($event)">
                        <option *ngFor="let model of discoveredModels()" [value]="model">{{ model }}</option>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button class="secondary-btn" (click)="closeDiscovery()">Cancel</button>
                <button class="primary-btn" (click)="confirmDiscovery()" [disabled]="!selectedDiscoveredModel()">
                    Confirm Selection
                </button>
            </div>
        </div>
    </div>
</div>
